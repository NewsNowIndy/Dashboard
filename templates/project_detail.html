{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">
    {{ project.name }}
  </h2>
  <div>
    <b>Deadline:</b>
    {% set badge = project.deadline|daysleft_badge %}
    <span class="badge {{ badge }}">
      {% set n = project.deadline|daysleft_num %}
      {{ n if n != "" else "‚Äî" }}{% if n != "" %} days{% endif %}
    </span>
  </div>
  <form method="post" action="{{ url_for('project_update_deadline', slug=project.slug) }}" class="row g-2">
    <div class="col-auto">
      <label class="form-label">Deadline</label>
      <input type="date" name="deadline" class="form-control"
            value="{{ project.deadline.strftime('%Y-%m-%d') if project.deadline else '' }}">
    </div>
    <div class="col-auto align-self-end">
      <button class="btn btn-outline-light">Save</button>
    </div>
  </form>

  <!-- Status dropdown -->
  <form method="post" action="{{ url_for('project_update_status', slug=project.slug) }}" class="d-flex align-items-center gap-2">
    <label for="status" class="form-label m-0">Status:</label>
    <select class="form-select form-select-sm" id="status" name="status" onchange="this.form.submit()">
      {% for opt in ['Planned','Active','Completed'] %}
        <option value="{{ opt }}" {% if project.status.value == opt %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
  </form>
</div>
<a class="btn btn-outline-light" href="{{ url_for('project_export_pdf', pid=project.id) }}">
    Export Project PDF
  </a>  

<!-- Notes (top) -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Notes (Most Recent)</strong>
    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">Add Note</button>
  </div>
  <div class="card-body p-0">
    {% if notes %}
      <div class="table-responsive" style="max-height: 35vh; overflow-y: auto;">
        <table class="table table-sm table-hover mb-0 align-middle notes-table">
          <thead class="table-dark">
            <tr>
              <th>Title</th>
              <th style="width: 220px;">Date Added</th>
            </tr>
          </thead>
          <tbody>
            {% for n in notes %}
            <tr>
              <td>
                <a href="#"
                   class="text-decoration-none"
                   data-bs-toggle="modal"
                   data-bs-target="#viewNoteModal"
                   data-note-title="{{ n.title|e }}"
                   data-note-body="{{ (n.body or '')|e }}"
                   data-note-date="{{ n.created_at|localfmt('%m-%d-%Y %H:%M') }}">
                  {{ n.title }}
                </a>
              </td>
              <td>{{ n.created_at|localfmt('%m-%d-%Y %H:%M') }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-3">
        <div class="alert alert-secondary mb-0">No notes yet.</div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Case Notebook -->
<div class="card mt-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Case Notebook</strong>
    <form class="d-flex gap-2" method="post" action="{{ url_for('notebook.add', slug=project.slug) }}">
      <select class="form-select form-select-sm" name="kind" style="width:auto">
        <option value="fact">Fact</option><option value="lead">Lead</option>
        <option value="question">Question</option><option value="quote">Quote</option>
        <option value="task">Task</option><option value="source">Source</option>
      </select>
      <input class="form-control form-control-sm" name="title" placeholder="Title">
      <input class="form-control form-control-sm" name="body"  placeholder="Details (optional)">
      <input class="form-control form-control-sm" name="source_url" placeholder="Link (optional)">
      <button class="btn btn-sm btn-primary">Add</button>
    </form>
  </div>
  <div class="card-body p-0">
    <table class="table table-sm mb-0 align-middle">
      <thead class="table-dark"><tr><th>Type</th><th>Title</th><th>Details</th><th>Source</th><th>When</th><th></th></tr></thead>
      <tbody>
      {% for n in notebook %}
        <tr>
          <td>{{ n.kind|title }}{% if n.is_pinned %} üìå{% endif %}</td>
          <td>{{ n.title }}</td>
          <td class="text-wrap">{{ n.body }}</td>
          <td>{% if n.source_url %}<a href="{{ n.source_url }}" target="_blank">link</a>{% else %}‚Äî{% endif %}</td>
          <td>{{ n.created_at|localfmt }}</td>
          <td class="text-end">
            <form method="post" action="{{ url_for('notebook.pin', entry_id=n.id) }}" class="d-inline">
              <button class="btn btn-sm btn-outline-light">{{ 'Unpin' if n.is_pinned else 'Pin' }}</button>
            </form>
            <form method="post" action="{{ url_for('notebook.delete', entry_id=n.id) }}" class="d-inline" onsubmit="return confirm('Delete?')">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      {% if not notebook or not notebook|length %}
        <tr><td colspan="6" class="text-center text-muted py-3">No entries yet.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Documents (existing list) -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Documents</strong>

    <!-- Upload (auto-submit on pick) -->
    <form class="d-flex align-items-center gap-2"
          method="post"
          action="{{ url_for('project_mcpo_upload') }}"
          enctype="multipart/form-data">
      <!-- Hidden file input; label acts as the visible button -->
      <input class="d-none"
             type="file"
             name="files[]"
             id="docFiles"
             multiple
             accept=".pdf,.doc,.docx,.csv,.xlsx,.png,.jpg,.jpeg,.gif"
             onchange="this.form.submit()">
      <label for="docFiles" class="btn btn-sm btn-primary mb-0">Upload</label>
    </form>
  </div>

  <div class="card-body p-0">
    {% if docs %}
      <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
        <table class="table table-sm table-striped table-hover mb-0 align-middle">
          <thead class="table-dark">
            <tr>
              <th style="width: 40%;">Title</th>
              <th>Notes</th>
              <th style="width: 160px;">Uploaded</th>
              <th style="width: 220px;" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
          {% for d in docs %}
            <tr>
              <td>
                <a href="{{ url_for('project_doc_download', doc_id=d.id) }}" class="text-decoration-none">
                  {{ d.title or d.filename }}
                </a>
                <div class="small text-muted">
                  {{ d.filename }}{% if d.size %} ‚Äî {{ d.size }} bytes{% endif %}
                </div>
              </td>
              <td>{{ d.notes or '' }}</td>
              <td class="uploaded-cell">{{ d.uploaded_at|localfmt('%m-%d-%Y %H:%M') if d.uploaded_at else '‚Äî' }}</td>
              <td class="text-end">
                <a class="btn btn-sm btn-outline-info me-2" href="{{ url_for('project_doc_download', doc_id=d.id) }}">Open</a>
                <form method="post" action="{{ url_for('project_doc_delete', doc_id=d.id) }}" style="display:inline;"
                      onsubmit="return confirm('Delete this document? This cannot be undone.');">
                  <button class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-3">
        <div class="alert alert-secondary mb-0">No documents yet.</div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Media section (always shown) -->
<div class="card mt-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Audio/Video</strong>
    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('media.index') }}">Open Media</a>
  </div>
  <div class="card-body p-0">
    {% if media and media|length %}
      <table class="table table-sm table-hover mb-0 align-middle">
        <thead class="table-dark">
          <tr>
            <th>Title</th>
            <th style="width: 120px;">Duration</th>
            <th style="width: 180px;">Added</th>
            <th style="width: 220px;" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for m in media %}
          <tr>
            <td class="text-wrap">
              <a href="{{ url_for('media.view', media_id=m.id) }}" class="text-decoration-none">
                {{ m.title or m.filename }}
              </a>
              <div class="small text-muted">{{ m.filename }}</div>
            </td>
            <td>{{ m.duration_seconds or '‚Äî' }}</td>
            <td>{{ m.created_at|localfmt }}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-info me-2" href="{{ url_for('media.view', media_id=m.id) }}">Open</a>
              <form method="post"
                    action="{{ url_for('media.delete', media_id=m.id) }}"
                    class="d-inline"
                    onsubmit="return confirm('Delete this media? This cannot be undone.');">
                <button class="btn btn-sm btn-outline-danger">Delete</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="p-3">
        <div class="alert alert-secondary mb-0">No Media Uploaded.</div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('project_add_note', slug=project.slug) }}" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addNoteLabel">Add Note</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input type="text" name="title" class="form-control" required maxlength="255">
        </div>
        <div class="mb-3">
          <label class="form-label">Notes</label>
          <textarea name="body" class="form-control" rows="5" placeholder="Write your note‚Ä¶"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary">Save Note</button>
      </div>
    </form>
  </div>
</div>

<!-- View Note Modal -->
<div class="modal fade" id="viewNoteModal" tabindex="-1" aria-labelledby="viewNoteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewNoteLabel">Note</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h5 id="vn-title" class="mb-2"></h5>
        <div id="vn-date" class="text-muted small mb-3"></div>
        <div id="vn-body" style="white-space: pre-wrap;"></div>
      </div>
    </div>
  </div>
</div>

{% if datasets and datasets|length %}
<div class="card mt-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>Workbench Datasets</strong>
    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('workbench_upload') }}">Upload another</a>
  </div>
  <div class="card-body p-0">
    <table class="table table-sm mb-0">
      <thead class="table-light">
        <tr>
          <th>Name</th>
          <th>Uploaded</th>
          <th>Rows Linked</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for ds in datasets %}
        <tr>
          <td>{{ ds.name }}</td>
          <td>{{ ds.uploaded_at|localfmt }}</td>
          <td>
            {{ ds.links|length if ds.links is defined else '' }}
          </td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('workbench_view', ds_id=ds.id) }}">Open Workbench</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="alert alert-secondary mt-3">
  No datasets linked yet. <a href="{{ url_for('workbench_upload') }}">Upload one</a> and pick ‚ÄúMCPO Plea Deals‚Äù as the project.
</div>
{% endif %}

<style>
  .uploaded-cell { color: #fff !important; }
  .notes-table tbody td { color: #fff !important; }
  .notes-table tbody td a { color: var(--bs-link-color); }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const viewNoteModal = document.getElementById('viewNoteModal');
    if (viewNoteModal) {
      viewNoteModal.addEventListener('show.bs.modal', function (event) {
        const link = event.relatedTarget;
        document.getElementById('vn-title').textContent = link.getAttribute('data-note-title') || '';
        document.getElementById('vn-body').textContent  = link.getAttribute('data-note-body') || '';
        document.getElementById('vn-date').textContent  = link.getAttribute('data-note-date') || '';
      });
    }
  });
</script>

{% endblock %}
